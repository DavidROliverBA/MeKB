name: MeKB CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pytest
      - name: Run secret detection
        run: |
          # Exclude test fixtures, the scanner itself, and documentation that
          # describes secret patterns (all contain intentional synthetic examples)
          find . -type f \( -name "*.md" -o -name "*.py" -o -name "*.yml" -o -name "*.yaml" -o -name "*.json" \) \
            ! -path "./scripts/tests/*" \
            ! -path "./scripts/detect-secrets.py" \
            ! -path "./scripts/README.md" \
            ! -path "./.claude/prompts/*" \
            ! -path "./.git/*" \
            | python3 scripts/detect-secrets.py
      - name: Validate security config
        run: python3 -c "import json; json.load(open('.mekb/security.json'))"
      - name: Run security tests
        run: python3 -m pytest scripts/tests/test_security.py -v

  search-index:
    name: Search Index
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pytest
      - name: Build search index
        run: python3 scripts/build-index.py && python3 scripts/build-index.py --stats
      - name: Run search tests
        run: python3 -m pytest scripts/tests/test_search.py -v

  graph:
    name: Knowledge Graph
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pytest
      - name: Build knowledge graph
        run: python3 scripts/build-graph.py --stats
      - name: Run graph tests
        run: python3 -m pytest scripts/tests/test_graph.py -v

  skills:
    name: Skill Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pytest
      - name: Validate skill format
        run: python3 -m pytest scripts/tests/test_skills.py -v
      - name: Count skills
        run: |
          count=$(find .claude/skills -name "SKILL.md" | wc -l)
          echo "Found $count skills"

  site:
    name: Site Generator
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pytest
      - name: Run site generator tests
        run: python3 -m pytest scripts/tests/test_site.py -v

  webhook:
    name: Webhook Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pytest
      - name: Run webhook tests
        run: python3 -m pytest scripts/tests/test_webhook.py -v

  utilities:
    name: Utility Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pytest
      - name: Run utility tests
        run: >
          python3 -m pytest
          scripts/tests/test_browse.py
          scripts/tests/test_notify.py
          scripts/tests/test_stale.py
          scripts/tests/test_schedule.py
          scripts/tests/test_embeddings.py
          scripts/tests/test_skill_tools.py
          -v
